# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a PayloadCMS 3.x application deployed on Cloudflare Workers using OpenNext.js for Cloudflare. The stack combines Next.js 15, Payload CMS, and Cloudflare infrastructure (D1 SQLite database + R2 object storage).

## Development Commands

### Running the Application

```bash
pnpm dev                    # Start Next.js dev server with Payload admin
pnpm devsafe                # Clean rebuild: removes .next and .open-next, then starts dev
pnpm start                  # Start production Next.js server
```

### Building and Deployment

```bash
pnpm build                  # Build Next.js application
pnpm deploy                 # Full deployment: migrate database + deploy to Cloudflare
pnpm deploy:database        # Run migrations and optimize D1 database
pnpm deploy:app             # Build and deploy to Cloudflare Workers
pnpm preview                # Build and preview locally before deployment
```

**Important**: Set `CLOUDFLARE_ENV` environment variable when deploying to different environments (e.g., `CLOUDFLARE_ENV=staging pnpm run deploy`).

### Testing

```bash
pnpm test                   # Run all tests (integration + e2e)
pnpm test:int               # Run integration tests only (Vitest)
pnpm test:e2e               # Run end-to-end tests (Playwright)
```

- Integration tests: Located in `tests/int/`, use Vitest with jsdom
- E2E tests: Located in `tests/e2e/`, use Playwright with Chromium
- E2E tests auto-start dev server on port 3000

### Code Quality

```bash
pnpm lint                   # Run ESLint
```

### Payload CMS

```bash
pnpm payload                                  # Run Payload CLI commands
pnpm payload migrate:create                   # Create new database migration
pnpm generate:types                           # Generate TypeScript types for Payload + Cloudflare
pnpm generate:types:payload                   # Generate Payload types only
pnpm generate:types:cloudflare                # Generate Cloudflare env types only
pnpm generate:importmap                       # Generate import map for Payload admin
```

### Cloudflare Wrangler

```bash
pnpm wrangler login         # Authenticate with Cloudflare
pnpm wrangler help          # See all Wrangler commands
```

## Architecture

### Next.js App Router Structure

The application uses Next.js 15 App Router with route groups:

- `src/app/(payload)/`: Payload admin panel routes
  - `/admin/`: Admin UI (handled by Payload)
  - `/api/`: Payload REST/GraphQL API endpoints
  - Custom admin styling in `custom.scss`

- `src/app/(frontend)/`: Public-facing frontend routes
  - Root page and layouts for end users
  - Separate from Payload admin

- `src/app/my-route/`: Example custom API route demonstrating Next.js route handlers

Route groups `(payload)` and `(frontend)` organize code without affecting URL structure.

### Payload CMS Configuration

**Main config**: `src/payload.config.ts`

Key architectural patterns:

1. **Cloudflare Context Handling**: The config detects whether it's running in production (Cloudflare Workers) or development (local with Wrangler), and fetches appropriate bindings (D1, R2) accordingly. This happens at build/runtime via `getCloudflareContext()`.

2. **Collections**: Defined in `src/collections/`
   - `Users.ts`: Auth-enabled collection for admin users
   - `Media.ts`: Upload collection for R2 storage (crop/focalPoint disabled - not supported on Workers)

3. **Database**: Uses `@payloadcms/db-d1-sqlite` adapter connecting to Cloudflare D1
   - Migrations stored in `src/migrations/`
   - D1 database binding: `cloudflare.env.D1`

4. **Storage**: Uses `@payloadcms/storage-r2` plugin
   - R2 bucket binding: `cloudflare.env.R2`
   - Configured for `media` collection only

5. **Import Map**: Payload admin uses import map (generated via `pnpm generate:importmap`) for proper module resolution in browser

### TypeScript Configuration

- Path alias: `@/*` maps to `src/*`
- Special alias: `@payload-config` maps to `src/payload.config.ts`
- Webpack configured with `.extensionAlias` to resolve `.ts`/`.tsx` as `.js`/`.jsx`
- Generated types: `src/payload-types.ts` (Payload schemas) and `cloudflare-env.d.ts` (Cloudflare bindings)

### Cloudflare Configuration

**File**: `wrangler.jsonc`

- **Main entry**: `.open-next/worker.js` (generated by OpenNext.js)
- **Assets**: Static files served from `.open-next/assets`
- **Compatibility flags**:
  - `nodejs_compat`: Enables Node.js APIs in Workers
  - `global_fetch_strictly_public`: Restricts fetch to public URLs
- **Bindings**:
  - D1 database: `binding: "D1"`
  - R2 bucket: `binding: "R2"`
  - Assets: `binding: "ASSETS"`

**Multi-environment setup**: Uncomment and configure the `env` section in `wrangler.jsonc` to add staging/production environments. Deploy with `CLOUDFLARE_ENV=<env_name> pnpm run deploy`.

### OpenNext.js Integration

**Config**: `open-next.config.ts` (minimal - uses defaults)

OpenNext.js transforms the Next.js build output into a Cloudflare Worker bundle. It handles:
- Server-side rendering on Workers runtime
- Asset serving from R2
- API route handling
- Middleware execution

## Known Limitations

1. **GraphQL**: Full GraphQL support not guaranteed on Cloudflare Workers due to upstream runtime issues
2. **Worker Size**: Requires Paid Workers plan (3MB limit on free tier is insufficient)
3. **Image Processing**: Sharp-based features (crop, focalPoint) unavailable in Media collection - Workers don't support native modules
4. **Bundle Size**: Be cautious importing large libraries - may hit Worker bundle limits

## Environment Variables

Required in `.env` (use `.env.example` as template):

- `PAYLOAD_SECRET`: Generate with `openssl rand -hex 32`

Cloudflare bindings (D1, R2) are configured in `wrangler.jsonc` and accessed via `cloudflare.env` in code.

## Migration Workflow

1. Make schema changes to collections in `src/collections/`
2. Run `pnpm payload migrate:create` to generate migration
3. Review generated migration in `src/migrations/`
4. Test locally with `pnpm dev` (Wrangler applies migrations to local D1)
5. Deploy with `pnpm deploy` (runs migrations on remote D1)

## Adding New Collections

1. Create collection file in `src/collections/` (follow `Users.ts` or `Media.ts` pattern)
2. Import and add to `collections` array in `src/payload.config.ts`
3. Run `pnpm generate:types` to update TypeScript types
4. Create migration: `pnpm payload migrate:create`
5. If collection uses uploads, configure in `r2Storage` plugin options
